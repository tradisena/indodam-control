<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
  <title>THB Indodam</title>
  <style>
    :root{
      --bg:#ffffff; --ink:#0a0a0a; --mut:#6b7280; --line:#e5e7eb;
      --green:#16a34a; --red:#dc2626; --blue:#2563eb; --yellow:#f59e0b; --violet:#7c3aed;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    :where(p,span,small,td,th,button,input,label,div){font-size:12px}
    .wrap{max-width:520px;margin:0 auto;height:100dvh;display:flex;flex-direction:column}
    header{padding:6px 10px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:8px}
    header h1{margin:0;font-size:13px;font-weight:800}
    .badge{padding:2px 6px;border-radius:8px;border:1px solid var(--line);font-weight:700}
    .ok{background:#eafff2;color:var(--green);border-color:#bbf7d0}
    .warn{background:#fff7ed;color:#b45309;border-color:#fed7aa}
    .off{background:#fee2e2;color:#b91c1c;border-color:#fecaca}

    .tabs{display:flex;border-top:1px solid var(--line)}
    .tab{flex:1;text-align:center;padding:8px 0;cursor:pointer;border-right:1px solid var(--line);background:#fafafa}
    .tab:last-child{border-right:0}
    .tab.active{background:#fff}
    .screen{flex:1;overflow:auto}
    .panel{display:none; padding:8px}
    .panel.active{display:block}

    .row{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .row + .row{margin-top:6px}
    .box{border:1px solid var(--line);border-radius:8px;padding:6px}
    .box h4{margin:0 0 4px 0;font-size:11px;color:var(--mut);font-weight:700}
    .big{font-size:16px;font-weight:900}
    .mut{color:var(--mut)}
    .up{color:var(--green)} .dn{color:var(--red)}
    .dis{opacity:.5;pointer-events:none}

    table{width:100%;border-collapse:collapse}
    th,td{padding:6px;border-bottom:1px solid var(--line);text-align:right;white-space:nowrap}
    th:first-child, td:first-child{text-align:left}
    thead th{font-size:11px;color:var(--mut)}
    tbody tr:hover{background:#fafafa}

    .btn{padding:8px 10px;border:1px solid var(--line);border-radius:9px;background:#fff;cursor:pointer;font-weight:800}
    .btn:active{transform:translateY(1px)}
    .b-buy{background:#eafaea;border-color:#bbf7d0;color:var(--green)}
    .b-sell{background:#feeceb;border-color:#fecaca;color:var(--red)}
    .b-close{background:#ffecec;border-color:#fecaca;color:var(--red)}
    .b-be{background:#eef2ff;border-color:#c7d2fe;color:var(--blue)}
    .b-add{background:#f3e8ff;border-color:#e9d5ff;color:var(--violet)}
    .b-toggle{background:#fff7ed;border-color:#fed7aa;color:#b45309}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:6px}
    .grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:6px}

    .switch{display:inline-flex;align-items:center;gap:6px}
    .switch input{width:30px;height:16px;appearance:none;background:#e5e7eb;border-radius:999px;position:relative;outline:none;cursor:pointer}
    .switch input:checked{background:#bae6fd}
    .switch input::after{content:'';position:absolute;width:14px;height:14px;background:#fff;border:1px solid #cbd5e1;border-radius:50%;top:1px;left:1px;transition:all .15s}
    .switch input:checked::after{left:15px}
    .hint{font-size:10px;color:var(--mut)}
    .bar{height:6px;background:#f3f4f6;border-radius:6px;overflow:hidden}
    .bar>i{display:block;height:100%}
    canvas{display:block;width:100%;height:220px;border:1px solid var(--line);border-radius:8px;background:#fff}
    .lot-wrap{display:flex;gap:6px;align-items:center}
    .lot{width:56px;padding:6px;border:1px solid var(--line);border-radius:8px}
  </style>
</head>
<body>
<div class="wrap">
  <!-- HEADER -->
  <header>
    <h1>THB Indodam</h1>
    <span id="badgeConn" class="badge off">OFFLINE</span>
    <span id="badgeMode" class="badge warn">MANUAL</span>
    <span id="badgeTrend" class="badge">SIDE</span>
  </header>

  <!-- SCREEN -->
  <div class="screen">
    <!-- CHART (default) -->
    <section id="p-chart" class="panel active">
      <div class="box">
        <div class="row">
          <div><span class="mut">Symbol</span> <b id="sym">XAUUSDc</b></div>
          <div class="big" id="price">-</div>
        </div>
        <canvas id="chart"></canvas>
        <div class="row" style="margin-top:6px">
          <div>Equity: <b id="equity">-</b> <span class="mut">| Free:</span> <b id="free">-</b></div>
          <div>Daily P/L: <b id="dailyPL">0.00</b></div>
        </div>
        <div class="bar" style="margin-top:4px"><i id="progress" style="width:0%;background:linear-gradient(90deg,#fecaca,#e5e7eb,#bbf7d0)"></i></div>
        <div class="row" style="margin-top:6px;flex-wrap:wrap;gap:10px">
          <label class="switch"><input id="swTPSM" type="checkbox"><span>Auto TPSM</span></label>
          <label class="switch"><input id="swTPSB" type="checkbox"><span>Auto TPSB</span></label>
          <label class="switch"><input id="swABE"  type="checkbox"><span>Auto Breakeven</span></label>
        </div>
        <div class="grid2" style="margin-top:6px">
          <button class="btn b-close" id="btnClose">Close All</button>
          <button class="btn b-be" id="btnBE">Breakeven</button>
          <button class="btn b-add" id="btnAdd">+ Add</button>
          <button class="btn b-toggle" id="btnAuto">Auto/Manual</button>
        </div>
      </div>
      <div class="grid4" style="margin-top:6px">
        <div class="box"><h4>vSL</h4><b id="vsl">0.00</b></div>
        <div class="box"><h4>Peak P/L</h4><b id="peak">0.00</b></div>
        <div class="box"><h4>Timer</h4><b id="timer">00:00</b></div>
        <div class="box"><h4>Adds</h4><b id="adds">0</b></div>
      </div>
      <div class="grid2" style="margin-top:6px">
        <div class="lot-wrap">
          <span class="mut">Lot</span><input id="lot" class="lot" type="number" step="0.01" min="0.01" value="0.01">
        </div>
        <div class="row" style="gap:6px;justify-content:flex-end">
          <button class="btn b-buy" id="btnBuy">BUY</button>
          <button class="btn b-sell" id="btnSell">SELL</button>
        </div>
      </div>
      <p class="hint" style="margin-top:4px">Eksekusi mengikuti kompas tren & TPS; tombol disable saat offline/locked.</p>
    </section>

    <!-- QUOTE -->
    <section id="p-quote" class="panel">
      <div class="box">
        <h4>Quote</h4>
        <div style="border:1px solid var(--line);border-radius:8px;max-height:260px;overflow:auto">
          <table id="tblQuote">
            <thead><tr><th>Symbol</th><th>Bid</th><th>Ask</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="hint">Ketuk simbol untuk memilih (real list dari MT5).</div>
      </div>
    </section>

    <!-- TRADE -->
    <section id="p-trade" class="panel">
      <div class="box">
        <div class="row">
          <div>Total Lot: <b id="totalLot">0.00</b> (<span id="openCount">0</span>)</div>
          <div>Floating: <b id="floatPL">0.00</b></div>
        </div>
        <div style="margin-top:6px;max-height:220px;overflow:auto;border:1px solid var(--line);border-radius:8px">
          <table id="tblOpen">
            <thead><tr><th>#</th><th>Side</th><th>Lot</th><th>Entry</th><th>Now</th><th>P/L</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="row" style="margin-top:6px">
          <div class="mut">Cooldown:</div><b id="cool">Ready</b>
        </div>
      </div>
    </section>

    <!-- RIWAYAT -->
    <section id="p-hist" class="panel">
      <div class="box">
        <h4>History Hari Ini</h4>
        <div style="max-height:280px;overflow:auto;border:1px solid var(--line);border-radius:8px">
          <table id="tblHist">
            <thead><tr>
              <th>#</th><th>Symbol</th><th>Side</th><th>Lot</th><th>Start</th><th>Close</th><th>Profit</th><th>UTC</th><th>Exec</th>
            </tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

  <!-- TABS -->
  <nav class="tabs">
    <div class="tab" data-tab="quote">Quote</div>
    <div class="tab active" data-tab="chart">Chart</div>
    <div class="tab" data-tab="trade">Trade</div>
    <div class="tab" data-tab="hist">Riwayat</div>
  </nav>
</div>

<script>
  // ---------- helpers ----------
  const $ = s=>document.querySelector(s);
  const tb = id=>document.getElementById(id).querySelector('tbody');
  const fmt = n => (Number(n)||0).toFixed(2);
  function setBadge(el, text, cls){ el.textContent=text; el.className='badge '+cls; }
  function colorize(el, val){ el.classList.remove('up','dn'); if(val>0) el.classList.add('up'); if(val<0) el.classList.add('dn'); }
  function disControls(dis){
    ['btnClose','btnBE','btnAdd','btnAuto','btnBuy','btnSell'].forEach(id=>{
      const b = document.getElementById(id); if(!b) return; b.classList.toggle('dis', !!dis);
    });
  }
  // ---------- Tabs ----------
  document.querySelectorAll('.tab').forEach(t=>{
    t.onclick=()=>{
      document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
      document.querySelectorAll('.panel').forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      document.getElementById('p-'+t.dataset.tab).classList.add('active');
    };
  });

  // ---------- API ----------
  async function get(path){ const r=await fetch(path,{cache:"no-cache"}); if(!r.ok) throw new Error(r.status); return r.json(); }
  async function post(path, body){ const r=await fetch(path,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body||{})}); if(!r.ok) throw new Error(r.status); return r.json(); }

  // ---------- Chart (canvas lightweight) ----------
  const cvs = document.getElementById('chart');
  const ctx = cvs.getContext('2d');
  const CHART_HEIGHT = 220;
  let lastWidth = 0;
  function resizeCanvas(){
    const rect = cvs.getBoundingClientRect();
    const targetHeight = CHART_HEIGHT;
    if (lastWidth !== rect.width || cvs.height !== targetHeight*2){
      lastWidth = rect.width;
      cvs.width = Math.floor(rect.width*2);
      cvs.height = targetHeight*2;
      drawChart();
    }
  }
  window.addEventListener('resize', resizeCanvas);
  let CANDLES = []; // {time, open, high, low, close}
  let LIVE_PRICE = null;
  function ema(arr, p){
    const k = 2/(p+1); let out = [], prev=null;
    for(let i=0;i<arr.length;i++){ const v=arr[i]; prev = (prev===null)? v : prev + k*(arr[i]-prev); out.push(prev); }
    return out;
  }
  function sma(arr, p){
    const out=[]; let sum=0;
    for(let i=0;i<arr.length;i++){ sum+=arr[i]; if(i>=p) sum-=arr[i-p]; out.push(i>=p-1? sum/p : arr[i]); }
    return out;
  }
  function drawChart(){
    if(!ctx){ return; }
    ctx.clearRect(0,0,cvs.width,cvs.height);
    if(CANDLES.length<5){ return; }
    const padL=38, padR=8, padT=8, padB=16;
    const w = cvs.width, h = cvs.height;
    const lows = CANDLES.map(d=>d.low), highs=CANDLES.map(d=>d.high);
    let min = Math.min(...lows), max = Math.max(...highs);
    const latestPrice = (typeof LIVE_PRICE === 'number' && !Number.isNaN(LIVE_PRICE)) ? LIVE_PRICE : null;
    if(latestPrice !== null){
      min = Math.min(min, latestPrice);
      max = Math.max(max, latestPrice);
    }
    const x0 = padL, x1 = w-padR, y0 = padT, y1 = h-padB;
    const n = CANDLES.length;
    const cw = (x1-x0)/n;

    // grid
    ctx.strokeStyle='#eee'; ctx.lineWidth=1;
    for(let i=0;i<4;i++){ const y=y0 + (y1-y0)*i/3; ctx.beginPath(); ctx.moveTo(x0,y); ctx.lineTo(x1,y); ctx.stroke(); }

    const closes=CANDLES.map(d=>d.close);
    const ema9 = ema(closes,9), ma20=sma(closes,20), ema50=ema(closes,50);
    const yv = v => y1 - (v-min)/(max-min+1e-9)*(y1-y0);

    // candles
    for(let i=0;i<n;i++){
      const d=CANDLES[i], x = x0 + i*cw + cw*0.5;
      ctx.strokeStyle='#999'; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(x, yv(d.high)); ctx.lineTo(x, yv(d.low)); ctx.stroke();
      const up = d.close>=d.open;
      ctx.fillStyle = up? '#16a34a':'#dc2626';
      const yOpen=yv(d.open), yClose=yv(d.close);
      const bh = Math.max(1, Math.abs(yClose - yOpen));
      ctx.fillRect(x-cw*0.28, Math.min(yOpen,yClose), cw*0.56, bh);
    }

    // S/R (15 candle)
    const win = CANDLES.slice(-15);
    if(win.length){
      const s = Math.min(...win.map(d=>d.low));
      const r = Math.max(...win.map(d=>d.high));
      ctx.setLineDash([4,3]);
      ctx.lineWidth=2.5; ctx.strokeStyle='#10b981';
      ctx.beginPath(); ctx.moveTo(x0,yv(s)); ctx.lineTo(x1,yv(s)); ctx.stroke();
      ctx.strokeStyle='#ef4444';
      ctx.beginPath(); ctx.moveTo(x0,yv(r)); ctx.lineTo(x1,yv(r)); ctx.stroke();
      ctx.setLineDash([]);
    }

    // Live price line
    if(latestPrice !== null){
      ctx.strokeStyle='#facc15';
      ctx.lineWidth=3;
      const yp = yv(latestPrice);
      ctx.beginPath(); ctx.moveTo(x0, yp); ctx.lineTo(x1, yp); ctx.stroke();
    }

    // MAs
    function line(arr, color){
      ctx.strokeStyle=color; ctx.lineWidth=2; ctx.beginPath();
      for(let i=0;i<n;i++){
        const x = x0 + i*cw + cw*0.5, y=yv(arr[i]);
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      }
      ctx.stroke();
    }
    line(ema9,'#16a34a'); line(ma20,'#2563eb'); line(ema50,'#7c3aed');
  }

  // ---------- UI wiring ----------
  function renderStatus(s){
    setBadge($('#badgeConn'), s.online? 'ONLINE':'OFFLINE', s.online?'ok':'off');
    setBadge($('#badgeMode'), s.auto_mode? 'AUTO':'MANUAL', s.auto_mode?'warn':'');
    setBadge($('#badgeTrend'), s.mode||'SIDE','');

    $('#sym').textContent = s.symbol || 'XAUUSDc';
    $('#price').textContent = fmt(s.price||0);
    colorize($('#price'), (s.tick_dir||0));
    const livePrice = Number(s.price);
    LIVE_PRICE = (s.online && Number.isFinite(livePrice)) ? livePrice : null;
    drawChart();
    $('#equity').textContent = fmt(s.equity||0);
    $('#free').textContent   = fmt(s.free_margin||0);
    $('#dailyPL').textContent= fmt(s.daily_pl||0);
    colorize($('#dailyPL'), s.daily_pl||0);
    const tg = Math.max(0.0001, (s.daily_target||10) - (s.daily_min||-10));
    const prog = Math.min(100, Math.max(0, ((s.daily_pl||0) - (s.daily_min||-10)) / tg * 100));
    $('#progress').style.width = prog + '%';

    $('#swTPSM').checked = !!s.tpsm_auto;
    $('#swTPSB').checked = !!s.tpsb_auto;
    $('#swABE').checked  = !!s.abe_auto;

    $('#vsl').textContent = fmt(s.vSL||0);
    $('#peak').textContent= fmt(s.best_pl||0);
    $('#timer').textContent= s.timer||'00:00';
    $('#adds').textContent = s.adds_done||0;

    $('#totalLot').textContent = fmt(s.total_lot||0);
    $('#openCount').textContent = s.open_count||0;
    $('#floatPL').textContent = fmt(s.float_pl||0);
    colorize($('#floatPL'), s.float_pl||0);
    $('#cool').textContent = s.cooldown? ('Cooling '+(s.cooldown_remain||'')):'Ready';

    const tbOpen = tb('tblOpen'); tbOpen.innerHTML='';
    (s.open_positions||[]).forEach((p,i)=>{
      const tr = document.createElement('tr');
      const pl = Number(p.pl||0);
      tr.innerHTML = `<td>${i+1}</td><td>${p.side||''}</td><td>${fmt(p.lot||0)}</td>
        <td>${fmt(p.entry||0)}</td><td>${fmt(s.price||0)}</td>
        <td class="${pl>0?'up':(pl<0?'dn':'')}">${fmt(pl)}</td>`;
      tbOpen.appendChild(tr);
    });

    const tbH = tb('tblHist'); tbH.innerHTML='';
    const hist = s.history_today||[];
    if(hist.length===0){
      const tr=document.createElement('tr');
      const td=document.createElement('td');
      td.colSpan=9; td.textContent='Belum ada posisi yang ditutup hari ini.';
      td.style.textAlign='center'; td.className='mut';
      tr.appendChild(td); tbH.appendChild(tr);
    }else{
      hist.forEach((r,i)=>{
        const pl = Number(r.profit||0);
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${i+1}</td><td>${r.symbol||''}</td><td>${r.side||''}</td>
          <td>${fmt(r.lot||0)}</td><td>${fmt(r.start||0)}</td><td>${fmt(r.close||0)}</td>
          <td class="${pl>0?'up':(pl<0?'dn':'')}">${fmt(pl)}</td><td>${r.time_utc||''}</td><td>${r.exec||'UNKNOWN'}</td>`;
        tbH.appendChild(tr);
      });
    }
    const qBody = tb('tblQuote'); qBody.innerHTML='';
    (s.quotes||[]).forEach((q)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td style="text-align:left">${q.symbol}</td><td>${fmt(q.bid)}</td><td>${fmt(q.ask)}</td>`;
      tr.onclick=()=>post('/api/symbol/select',{symbol:q.symbol}).then(()=>{ pull(); pullCandles(); });
      qBody.appendChild(tr);
    });

    const locked = !s.online || s.locked || s.cooldown;
    disControls(locked);
  }

  async function pull(){
    try{
      const s = await get('/api/status');
      window.__STATUS__ = s;
      renderStatus(s);
      if(s.online){ pullCandles(); } else { CANDLES = []; drawChart(); }
    }catch(e){
      setBadge($('#badgeConn'),'OFFLINE','off'); disControls(true);
    }
  }

  async function pullCandles(tf='M1', count=120){
    try{
      const sym = (window.__STATUS__ && window.__STATUS__.symbol) || 'XAUUSDc';
      const data = await get(`/api/candles?symbol=${encodeURIComponent(sym)}&tf=${tf}&count=${count}`);
      CANDLES = data.map(d=>({
        time: typeof d.time==='number'? d.time*1000 : Date.parse(d.time),
        open:+d.open, high:+d.high, low:+d.low, close:+d.close
      }));
      resizeCanvas();
      drawChart();
    }catch(e){}
  }

  // ---------- Actions ----------
  $('#btnClose').onclick = ()=>post('/api/action/close',{}).then(pull);
  $('#btnBE').onclick    = ()=>post('/api/action/breakeven',{}).then(pull);
  $('#btnAdd').onclick   = ()=>post('/api/action/add',{lot:+$('#lot').value||0.01}).then(pull);
  $('#btnAuto').onclick  = ()=>post('/api/strategy/toggle',{}).then(pull);
  $('#btnBuy').onclick   = ()=>post('/api/action/buy',{lot:+$('#lot').value||0.01}).then(pull);
  $('#btnSell').onclick  = ()=>post('/api/action/sell',{lot:+$('#lot').value||0.01}).then(pull);

  $('#swTPSM').onchange = (e)=>post('/api/strategy/tpsm',{on:e.target.checked}).then(pull);
  $('#swTPSB').onchange = (e)=>post('/api/strategy/tpsb',{on:e.target.checked}).then(pull);
  $('#swABE').onchange  = (e)=>post('/api/strategy/abe',{on:e.target.checked}).then(pull);

  // initial
  pull();
  setInterval(pull, 1000);
  resizeCanvas();
</script>
</body>
</html>
